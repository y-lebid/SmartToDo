<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartToDo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'coral-main': '#ff7f50',
                        'coral-dark': '#ff5722',
                        'coral-light': '#ffe8e0',
                        'coral-ring': '#ff7f5080',
                        'google-gray': '#bdc1c6',
                    }
                }
            }
        }
    </script>
    <style>
        #chat-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 450px;
            max-height: 80vh;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1050;
            display: flex;
            flex-direction: column;

            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);

            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
            will-change: opacity, transform, visibility;
        }

        #chat-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        #tasks-container-wrapper {
            transition: none;
        }

        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #ff7f50;
            border-radius: 3px;
        }
        .task-done {
            text-decoration: line-through;
            color: #bdc1c6;
        }

        .material-button {
            position: relative;
            overflow: hidden;
        }
        .material-button:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.4);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transition: all 0.5s ease-out;
        }
        .material-button:active:after {
            transform: scale(20, 20) translate(-50%, -50%);
            opacity: 1;
            transition: 0s;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 20px;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            position: relative;
            word-wrap: break-word;
        }

        .chat-bubble-user {
            background-color: #ff7f50;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble-other {
            background-color: #ffffff;
            color: #333333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .task-card-content {
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div id="tasks-container-wrapper">
        <nav class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex items-center">
                        <div class="w-2 h-8 bg-coral-main rounded-full mr-3"></div>
                        <a class="text-3xl font-extrabold text-gray-800 tracking-tight" href="#">SmartToDo</a>
                    </div>
                    <a class="text-coral-main border border-coral-main hover:bg-coral-light/50 px-4 py-2 rounded-full transition duration-150 text-sm font-medium material-button" href="/logout">
                        –í–∏—Ö—ñ–¥
                    </a>
                </div>
            </div>
        </nav>

        <div id="tasks-container" class="max-w-7xl mx-auto px-4 py-12">
            <h2 class="text-4xl font-light mb-8 text-gray-800">–°–ø–∏—Å–æ–∫ –ó–∞–¥–∞—á</h2>

            <form class="flex mb-10 bg-white rounded-3xl shadow-lg hover:shadow-xl transition duration-300 ease-in-out p-1" method="POST" action="/tasks">
                <input class="flex-grow p-4 text-lg text-gray-800 rounded-l-3xl border-none focus:outline-none focus:ring-4 focus:ring-coral-ring transition duration-150 placeholder-gray-500"
                       type="text" name="task" placeholder="–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –∑–∞–¥–∞—á—É..." required>
                <button class="bg-coral-main hover:bg-coral-dark text-white font-medium text-lg py-4 px-8 rounded-r-3xl transition duration-200 ease-in-out material-button shadow-md">
                    –î–æ–¥–∞—Ç–∏
                </button>
            </form>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {% for task in tasks %}
                <div class="rounded-2xl shadow-lg hover:shadow-xl transition duration-300 p-4 bg-white border border-transparent hover:border-coral-main/80 overflow-hidden">
                    <div class="task-card-content">
                        <div class="text-center">
                            <div class="flex items-center justify-center mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <p class="text-sm font-semibold text-coral-main">Task Category</p>
                            </div>

                            <h5 class="text-xl font-bold mb-4 leading-snug {% if task.status == 'done' %}task-done{% else %}text-gray-900{% endif %}">
                                {{ task.title }}
                            </h5>
                        </div>

                        <div class="flex justify-around pt-4 border-t border-gray-100 mt-4">
                            {% if task.status != 'done' %}
                            <a href="/complete/{{ task.id }}" title="–í–∏–∫–æ–Ω–∞–Ω–æ" class="p-3 text-green-500 hover:text-green-600 rounded-full hover:bg-green-50 transition duration-150 material-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                </svg>
                            </a>
                            {% else %}
                            <a href="/uncomplete/{{ task.id }}" title="–°–∫–∞—Å—É–≤–∞—Ç–∏" class="p-3 text-yellow-500 hover:text-yellow-600 rounded-full hover:bg-yellow-50 transition duration-150 material-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20h-5v-5" />
                                </svg>
                            </a>
                            {% endif %}

                            <a href="/delete/{{ task.id }}" title="–í–∏–¥–∞–ª–∏—Ç–∏" class="p-3 text-red-500 hover:text-red-600 rounded-full hover:bg-red-50 transition duration-150 material-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </a>

                            <a href="javascript:void(0)"
                                onclick="openFileModal('{{ task.id }}', '{{ task.title }}', '{{ task.status }}')"
                                title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ / –î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª"
                                class="p-3 text-blue-500 hover:text-blue-600 rounded-full hover:bg-blue-50 transition duration-150 material-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232a2.5 2.5 0 013.536 3.536L7.5 20.036H4v-3.5l11.232-11.304z" />
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="md:col-span-2 lg:col-span-3 xl:col-span-4">
                    <div class="p-6 text-center bg-white border border-gray-200 rounded-xl text-gray-600 shadow-sm">
                        –ó–∞–¥–∞—á –ø–æ–∫–∏ –Ω–µ–º–∞—î. –°—Ç–≤–æ—Ä—ñ—Ç—å —Å–≤–æ—é –ø–µ—Ä—à—É –∑–∞–¥–∞—á—É!
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="file-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md relative">
        <button onclick="closeFileModal()"
                class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
          ‚úñ
        </button>

        <h3 id="modal-task-title" class="text-xl font-bold text-gray-800 mb-2">–ù–∞–∑–≤–∞ –∑–∞–¥–∞—á—ñ</h3>
        <p id="modal-task-status" class="text-sm text-gray-500 mb-4">–°—Ç–∞—Ç—É—Å: </p>

        <form id="file-upload-form" class="mb-4" enctype="multipart/form-data" method="POST">
          <input type="file" name="file" id="file-input"
                 class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0 file:text-sm file:font-semibold
                        file:bg-coral-main file:text-white hover:file:bg-coral-dark" required>
          <button type="submit"
                  class="mt-3 w-full bg-coral-main hover:bg-coral-dark text-white py-2 rounded-lg">
            –î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª
          </button>
        </form>

        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2">–§–∞–π–ª–∏:</h4>
          <ul id="file-list" class="space-y-2 text-sm text-gray-600">
            <li class="text-gray-400">–§–∞–π–ª—ñ–≤ —â–µ –Ω–µ–º–∞—î</li>
          </ul>
        </div>
      </div>
    </div>


    <button id="chat-toggle" class="fixed bottom-6 right-6 lg:bottom-8 lg:right-8 bg-coral-main hover:bg-coral-dark text-white rounded-full w-16 h-16 shadow-2xl transition duration-200 ease-in-out focus:outline-none flex items-center justify-center text-3xl z-20 transform hover:scale-[1.05] material-button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
            <path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" />
        </svg>
    </button>

    <div id="chat-panel" class="bg-white shadow-2xl rounded-2xl">
        <div id="chat-header" class="bg-coral-main text-white p-4 text-lg font-bold rounded-t-xl flex justify-between items-center">
            –°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è
            <button id="chat-close" class="p-1 rounded-full hover:bg-coral-dark/50 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 flex flex-col space-y-4">
            <div class="text-center text-sm font-light text-gray-500">
                –û–Ω–ª–∞–π–Ω —á–∞—Ç
            </div>
            <button class="system-btn bg-coral-light text-coral-main hover:bg-coral-light/70 font-semibold p-2 rounded-lg transition duration-150 border border-coral-main/30"
                    id="search-user-btn">
                üîç –ü–æ—á–∞—Ç–∏ —á–∞—Ç –∑ —ñ–Ω—à–∏–º —é–∑–µ—Ä–æ–º
            </button>
        </div>
        <div id="chat-input" class="p-4 border-t border-gray-200 hidden">
            <div class="flex">
                <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."
                       class="flex-grow p-2 border border-google-gray/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-coral-main">
                <button id="send-btn" class="bg-coral-main hover:bg-coral-dark text-white font-medium px-4 py-2 ml-2 rounded-lg transition duration-150 material-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.183.654A1 1 0 004 18h12a1 1 0 00.894-1.447l-7-14z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

<script>
    // –û–≥–æ–ª–æ—à–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ HTML-–µ–ª–µ–º–µ–Ω—Ç—ñ–≤
    const fileModal = document.getElementById("file-modal");
    const modalTaskTitle = document.getElementById("modal-task-title");
    const modalTaskStatus = document.getElementById("modal-task-status");
    const fileList = document.getElementById("file-list");

    let currentTaskId = null; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID –∑–∞–¥–∞—á—ñ

    function openFileModal(taskId, title, status) {
        currentTaskId = taskId;
        modalTaskTitle.textContent = title;
        modalTaskStatus.textContent = "–°—Ç–∞—Ç—É—Å: " + status;
        fetchFilesForTask(taskId); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å–Ω—É—é—á—ñ —Ñ–∞–π–ª–∏
        fileModal.classList.remove("hidden");
        fileModal.classList.add("flex");
    }

    function closeFileModal() {
        fileModal.classList.add("hidden");
        fileModal.classList.remove("flex");
    }

    async function fetchFilesForTask(taskId) {
        const res = await fetch(`/files/${taskId}`);
        const files = await res.json();
        fileList.innerHTML = "";
        if (files.length > 0) {
            files.forEach(file => {
                const li = document.createElement("li");
                li.textContent = file.filename;
                fileList.appendChild(li);
            });
        } else {
            fileList.innerHTML = `<li class="text-gray-400">–§–∞–π–ª—ñ–≤ —â–µ –Ω–µ–º–∞—î</li>`;
        }
    }

    // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    document.getElementById("file-upload-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData();
        formData.append("task_id", currentTaskId); // –î–æ–¥–∞—î–º–æ ID –∑–∞–¥–∞—á—ñ
        formData.append("file", document.getElementById("file-input").files[0]);

        const res = await fetch("/upload", {
            method: "POST",
            body: formData
        });

        if (res.ok) {
            const data = await res.json();
            if (fileList.querySelector("li.text-gray-400")) {
                fileList.innerHTML = "";
            }
            const li = document.createElement("li");
            li.textContent = data.filename;
            fileList.appendChild(li);
            e.target.reset();
        } else {
            alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É!");
        }
    });

    // JS logic for chat
    const chatToggle = document.getElementById('chat-toggle');
    const chatClose = document.getElementById('chat-close');
    const chatPanel = document.getElementById('chat-panel');
    const tasksContainerWrapper = document.getElementById('tasks-container-wrapper');
    const searchUserBtn = document.getElementById('search-user-btn');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    let ws = null;
    let currentUser = null;

    // Toggle chat panel
    chatToggle.addEventListener('click', () => {
        chatPanel.classList.toggle('open');
    });

    // Close chat panel
    chatClose.addEventListener('click', () => {
        chatPanel.classList.remove('open');
    });

    searchUserBtn.addEventListener('click', () => {
        const nickname = prompt("–í–≤–µ–¥–∏ –ø–æ—à—Ç—É —é–∑–µ—Ä–∞ –¥–ª—è —á–∞—Ç—É:");
        if (nickname) {
            currentUser = nickname;
            chatMessages.innerHTML += `<div class="p-2 text-center text-sm font-medium bg-green-100 text-green-800 rounded-lg"><strong>–ó'—î–¥–Ω–∞–≤—Å—è –∑:</strong> ${nickname}</div>`;

            searchUserBtn.classList.add('hidden');
            chatInput.classList.remove('hidden');

            if (!ws) {
                try {
                    const userEmail = "{{ user.email }}";
                    ws = new WebSocket(`ws://127.0.0.1:8776/ws/chat?email=${userEmail}`);

                    ws.onmessage = (event) => {
                        let data;
                        try {
                            data = JSON.parse(event.data);
                        } catch (e) {
                            data = { type: "system", message: event.data };
                        }

                        const msgDiv = document.createElement("div");

                        if (data.type === "received_message") {
                            msgDiv.className = 'chat-bubble chat-bubble-other';
                            msgDiv.innerHTML = `<span class="text-sm font-normal">${data.sender}: ${data.content}</span>`;
                            chatMessages.appendChild(msgDiv);

                        } else if (data.type === "own_message") {
                            const ownDiv = document.createElement("div");
                            ownDiv.className = "flex justify-end";
                            msgDiv.className = 'chat-bubble chat-bubble-user';
                            msgDiv.innerHTML = `<span class="text-sm font-normal">${data.content}</span>`;
                            ownDiv.appendChild(msgDiv);
                            chatMessages.appendChild(ownDiv);

                        } else if (data.type === "error") {
                            msgDiv.className = 'p-2 text-center text-xs bg-red-100 text-red-800 rounded-lg';
                            msgDiv.innerText = data.message;
                            chatMessages.appendChild(msgDiv);

                        } else if (data.type === "status") {
                            msgDiv.className = 'p-2 text-center text-xs bg-blue-100 text-blue-800 rounded-lg';
                            msgDiv.innerText = data.message;
                            chatMessages.appendChild(msgDiv);
                        }

                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    };

                    ws.onopen = () => {
                        chatMessages.innerHTML += `<div class="p-2 text-center text-xs bg-blue-100 text-blue-800 rounded-lg">‚úÖ WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ!</div>`;
                    };

                    ws.onerror = (error) => {
                        console.error("WebSocket Error:", error);
                        chatMessages.innerHTML += `<div class="p-2 text-center text-xs bg-red-100 text-red-800 rounded-lg">‚ùå –ü–æ–º–∏–ª–∫–∞ WebSocket</div>`;
                    };

                    ws.onclose = () => {
                        chatMessages.innerHTML += `<div class="p-2 text-center text-xs bg-yellow-100 text-yellow-800 rounded-lg">‚ö†Ô∏è WebSocket –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ</div>`;
                    };

                } catch (e) {
                    console.error("Failed to connect WebSocket:", e);
                    chatMessages.innerHTML += `<div class="p-2 text-center text-xs bg-red-100 text-red-800 rounded-lg">–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è!</div>`;
                }
            }
        }
    });

    const sendMessage = () => {
        if (messageInput.value.trim() && ws && currentUser) {
            const message = messageInput.value.trim();
            const payload = JSON.stringify({
                username: currentUser,
                message: message
            });

            ws.send(payload);
            messageInput.value = '';
        }
    };

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>